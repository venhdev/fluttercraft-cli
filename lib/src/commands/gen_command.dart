import 'dart:io';

import 'package:args/command_runner.dart';
import 'package:path/path.dart' as p;

import '../core/build_config.dart';
import '../core/pubspec_parser.dart';
import '../utils/console.dart';

/// Command to generate fluttercraft.yaml configuration file
class GenCommand extends Command<int> {
  final Console console;

  GenCommand({Console? console}) : console = console ?? Console() {
    argParser.addFlag(
      'force',
      abbr: 'f',
      help: 'Overwrite existing fluttercraft.yaml',
      negatable: false,
    );
  }

  @override
  String get name => 'gen';

  @override
  String get description => 'Generate fluttercraft.yaml configuration file';

  @override
  Future<int> run() async {
    final force = argResults?['force'] == true;
    final projectRoot = Directory.current.path;
    final configPath = p.join(projectRoot, 'fluttercraft.yaml');
    final configFile = File(configPath);

    // Check if file exists
    if (await configFile.exists() && !force) {
      console.warning('fluttercraft.yaml already exists.');
      console.info('Use --force to overwrite.');
      return 1;
    }

    // Load pubspec to get app name and version
    final pubspecParser = PubspecParser(projectRoot: projectRoot);
    final pubspecInfo = await pubspecParser.parse();

    final appName = pubspecInfo?.name ?? 'app';
    final buildName = pubspecInfo?.buildName ?? '1.0.0';
    final buildNumber = pubspecInfo?.buildNumber ?? '1';

    // Detect FVM version from .fvmrc
    final fvmVersion = BuildConfig.detectFvmVersion(projectRoot);

    // Detect Shorebird app_id from shorebird.yaml
    final shorebirdAppId = BuildConfig.detectShorebirdAppId(projectRoot);

    // Generate config content
    final content = _generateConfigContent(
      appName: appName,
      buildName: buildName,
      buildNumber: buildNumber,
      fvmVersion: fvmVersion,
      shorebirdAppId: shorebirdAppId,
    );

    // Write file
    await configFile.writeAsString(content);

    console.success('Generated fluttercraft.yaml');
    console.info('Location: $configPath');
    console.info('App name: $appName');
    console.info('Version: $buildName+$buildNumber');
    if (fvmVersion != null) {
      console.info('FVM version: $fvmVersion (auto-detected)');
    }
    if (shorebirdAppId != null) {
      console.info('Shorebird app_id: $shorebirdAppId (auto-detected)');
    }

    return 0;
  }

  String _generateConfigContent({
    required String appName,
    required String buildName,
    required String buildNumber,
    String? fvmVersion,
    String? shorebirdAppId,
  }) {
    return '''# fluttercraft.yaml - Build Configuration
# Generated by fluttercraft CLI

# ──────────────────────────────────────────────
# App identifier (from pubspec or override here)
# ──────────────────────────────────────────────
app:
  name: $appName

# ──────────────────────────────────────────────
# Core build settings
# ──────────────────────────────────────────────
build:
  # Semantic version (x.y.z)
  name: $buildName
  # Build number (integer)
  number: $buildNumber
  # Build type: aab | apk | ipa | app
  type: aab
  # Flavor: dev | staging | prod | null
  flavor: null
  # Main entry point
  target: lib/main.dart

# ──────────────────────────────────────────────
# Output & Input paths
# ──────────────────────────────────────────────
paths:
  # Output directory for build artifacts
  output: dist
  # .env file path (optional)
  env: ./.env

# ──────────────────────────────────────────────
# Build flags
# ──────────────────────────────────────────────
flags:
  # Use dart-define-from-file
  use_dart_define: false
  # Run flutter clean before build
  need_clean: false
  # Run build_runner before build
  need_build_runner: false

# ──────────────────────────────────────────────
# FVM integration
# ──────────────────────────────────────────────
fvm:
  # Use FVM for flutter commands
  enabled: true
  # Pinned Flutter version (auto-detected from .fvmrc if null)
  version: ${fvmVersion ?? 'null'}

# ──────────────────────────────────────────────
# Shorebird integration
# ──────────────────────────────────────────────
shorebird:
  # Enable Shorebird for builds
  enabled: ${shorebirdAppId != null ? 'true' : 'false'}
  # App ID (auto-detected from shorebird.yaml)
  app_id: ${shorebirdAppId ?? 'null'}
  # @read-only [build:type] - Artifact type derived from build.type
  artifact: null
  # Skip confirmation prompts (maps to --no-confirm)
  no_confirm: true

# ──────────────────────────────────────────────
# Bundletool (AAB → APK conversion)
# ──────────────────────────────────────────────
bundletool:
  # Path to bundletool.jar (optional)
  path: null
  # Path to key.properties file
  keystore: android/key.properties

# ──────────────────────────────────────────────
# Custom command aliases
# ──────────────────────────────────────────────
alias:
  gen-icon:
    cmds:
      - fvm flutter pub get
      - fvm flutter pub run flutter_launcher_icons
  brn:
    cmds:
      - fvm flutter pub get
      - fvm flutter packages pub run build_runner build --delete-conflicting-outputs
''';
  }
}

